## Understanding the Basics

---

### Table of Contents
1. [How the Web Works](#how-the-web-works)
    - [HTTP, HTTPS](#http-https)
1. [Creating a Node Server](#creating-a-node-server)
    - [Core Modules](#core-modules)
    - [HTTP](#http)
1. [The Node Lifecycle and Event Loop](#the-node-lifecycle-and-event-loop)
    - [Starting the Server](#starting-the-server)
    - [The Event Loop](#the-event-loop)
1. [Understanding Requests](#understanding-requests)
    - [Headers](#headers)
    - [URL](#url)
1. [Sending Responses](#sending-responses)
1. [Request & Response Headers](#request-&-response-headers)
1. [Routing Requests](#routing-requests)
1. [Redirecting Requests](#redirecting-requests)
1. [Parsing Request Bodies](#parsing-request-bodies)
    - [Streams & Buffers](#streams-&-buffers)
1. [Understanding Event Driven Code Execution](#understanding-event-driven-code-execution)
1. [Blocking & Non-Blocking Code](#blocking-&-non-blocking-code)
    - [The Event Loop](#the-event-loop)
1. [Using the Node Modules System](#using-the-node-modules-system)
1. [Summary](#summary)
1. [Resources](#resources)


---

### How the Web Works
1. The user/client (browser)
    - Enters a url... which is an encoded human readable version of the domain
2. Client sends a request to the server with the domain
    - The server houses the code that handles the request and the rest of the website
- There are many different choices of server (nodejs, php, asp.net, ruby)
- There server can do many things such as communicate with a database along with housing code

#### HTTP, HTTPS
- To a handle a request and send back a response a browser can work with, we have to follow certain rules
    - these rules are defined the protocols we use (Http/Https)
- Hyper Text Transfer Protocol
    - a protocol for transferring data which is understood by Browser and Server
- Hyper Text Transfer Protocol Secure
    - HTTP + Data Encryption (during transmission)

### Creating a Node Server
- The root file of a node project is usually named ``app.js``, ``index.js``, or ``server.js``
- Node has many modules that can be installed, but it also has important built in modules

#### Core Modules
- **http**: launch a server and handle requests
- **https**: launch an SSL server
- **fs**: file system (read/write files)
- **path**: handle file paths (cross platform)
- **os**: operating system info (cpu, memory, etc)

#### HTTP
- The http module allows us to create a server
```js
const http = require('http')
```
- Because this is a global module, we don't need to use a relative path: ``./`` or ``../``
    - JavaScript automatically adds ``.js`` to the end of the file name

```js
createServer((req, res) => {
    // do something
})
```
- ``req`` is the request object called by nodejs whenever a request reaches the server
- ``res`` is the response object

```js
const server = http.createServer((req, res) => {
    console.log(req)
})

server.listen(3000)
```
- listen() starts a process that listens for incoming requests
    - listen takes optional arguments
        - ``port``: the port to listen on
        - ``hostname``: the hostname to listen on
        - ``backlog``: the maximum length of the queue of pending connections
        - ``callback``: a callback function that is executed once the server is bound
- port 80 is the default port for http, port 443 is the default port for https, and port 3000 is the default port for nodejs
    - we can use any port we want, but we have to make sure it's not being used by another process

### The Node Lifecycle and Event Loop
#### Starting the Server
- file is executed (``node app.js``)
    - starts the script
    - parse code, register variables and functions
#### The Event Loop
- The event loop in nodejs is process that keeps on running and checks for new events
    - it keeps running as long as there are event listeners registered
- The event loop is a product of javascript being single threaded
    - it's a way to handle async code
- ``process.exit()`` is used to exit the current process

### Understanding Requests
- The request object is generated by nodejs whenever a request reaches the server
    - this is possible because of the listener function we passed to the ``createServer`` method
- The request object contains a lot of useful information about the incoming request
#### Headers
- Headers are metadata about the request (and also included in responses)
    - host: the domain name of the server
    - user-agent: the browser that made the request
    - accept: the type of content the client is expecting
    - accept-language: the language the client is expecting
    - accept-encoding: the encoding the client is expecting
    - connection: the type of connection the client is using
    - upgrade-insecure-requests: whether the client is expecting an encrypted connection
    - cache-control: whether the client is expecting a cached response
    - cookie: the cookies the client is sending
#### URL
- The url is the path of the request
    - it's the part of the url after the domain name
    - it can also contain query parameters

### Sending Responses
- Get is the default http method used when entering a url in the browser
- setHeader is used to set the response headers
- write is used to write the response body
- end is used to end the response

### Request & Response Headers
- On both requests and responses, Http headers are added to transport metadata from A to B.
- The following article provides a great overview of available headers and their role: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers

### Routing Requests
- Routing is the process of determining how an application responds to a client request to a particular endpoint, which is a URI (or path) and a specific HTTP request method (GET, POST, and so on).
- GET requests are used to retrieve information from the given server using a given URI.
- POST requests are used to send data to the server, for example, customer information, file upload, etc. using HTML forms.
    - POST requests have to be set up in the server

### Redirecting Requests
```js
if (url === '/') {
    /// ...
}
```
- The ``url`` property of the request object contains the path of the request
- We can use this to redirect requests to different pages
```js
res.statusCode = 302
res.setHeader('Location', '/')
```
- We can use the ``statusCode`` property to set the status code of the response

### Parsing Request Bodies
- Incoming data is sent as a stream of data
#### Streams and Buffers
- A stream is an ongoing flow of data
- An incoming requests recieves chunks of data
- We are unable to arbitrarily work with chunks of data
    - In order to do so, a buffer is used
- A buffers holds chunks of data that can be accessed at any time
```js
req.on('data', (chunk) => {
    console.log(chunk)
})
```
- the ``on`` method is used to register a listener function
    - the first argument is the event name
    - the second argument is the listener function

### Understanding Event Driven Code Execution
- The order of execution of code is not necessarily the order in which it is written
- With even listeners such as createServer and req.on, nodejs uses the pattern of passing a function into a function
    - The passed in functions are executed at a later time (asynchronously)
- A passed in function isn't always executed at a later time, but nodejs uses the pattern heavily

### Blocking and Non-Blocking Code
- Blocking code is code that prevents other code from executing
    - Synchrnous code is blocking code:
    ```js
    fs.writeFileSync('test.txt', 'Hello World')
    ```
- Non-blocking code is code that doesn't prevent other code from executing
    - Asynchronous code is non-blocking code:
    ```js
    fs.writeFile('test.txt', 'Hello World', err => {
        res.statusCode = 302
        res.setHeader('Location', '/')
        return res.end()
    })
    ```

### Looking Behind the Scenes
- Nodejs uses a single thread to handle requests
    - This is why we can't use blocking code
- The requests are handled by an event loop
    - The event loop is a process that keeps on running and checks for new events
    - It keeps running as long as there are event listeners registered
- The worker pool is a pool of threads that handle long running tasks
    - The worker pool is used to handle blocking code
- When a file is finished being read in the worker pool, it is sent back to the event loop
    - The event loop then sends the data to the request handler
#### The Event Loop
- A process that is started by nodejs that keeps the nodejs process running handling all the callbacks
    1. At the beginning of each iteration, the loop checks if there are any timer callbacks to be executed (setTimeout, setInterval)
    1. Next, the loop checks if there are any pending callbacks to be executed (I/O callbacks, callbacks that were deferred)
        - I/O = Input/Output... Disk, Network Operations (~Blocking operations)
        - If there are too many outstanding callbacks, the loop iteration will continue postponing the execution of the callbacks until the next iteration
    1. The poll phase looks for new I/O events and attempts to execute callbacks immediately if possible.
        - If there are no callbacks to be executed, the poll phase will wait for a new I/O event to occur
        - If callback isn't executable immediately, it will be deferred to the next iteration
        - From here, the loop can jump back to the timers phase if there are any timers to be executed
    1. The check phase executes setImmediate callbacks
        - setImmediate is a special timer that runs in a separate phase of the event loop
    1. The close callbacks phase executes all close event callbacks
        - close events are emitted when a stream (e.g. a TCP socket) or a handle (e.g. a file descriptor) is closed
    1. At this point the loop can be exited if there are no remaining event handlers or timers
        - nodejs keeps track of the number of active event handlers and timers ``refs``
        - ``refs`` is incremented when a new event handler is added and decremented when an event handler is removed
        - createServer and listen prevent the loop from exiting

### Using the Node Modules System
- The main file of a nodejs project is the entry point of the application
```js
const http = require("http");
const routes = require("./routes");

const server = http.createServer(routes.handler);

server.listen(3000);
```
- require is a function that is used to import modules
    - The first argument is the path to the module
    - The second argument is the path to the module relative to the current file
    - If it is a global module, the path is the name of the module
- There are two ways of exporting code from a module
    ```js
    module.exports = requestHandler;
    ```
    ```js
    //routes.js
    module.exports = {
        handler: requestHandler,
        someText: 'Some hard coded text'
    }
    //app.js
    const server = http.createServer(routes.handler);
    console.log(routes.someText)
    ```
    ```
    ```

### Summary
- **How the Web Works**:
> Client => Request => Server => Response => Client
- **Program Lifecycles & Event Loop**:
    - Node.js runs non-blocking, event-driven code (event loop)
    - A node program exists as soon as there are no more work to do
    - The ``createServer()`` event never finishes by default
- **Asynchronous Code**:
    - JS code is non-blocking
    - Use callbacks and events
    - The order may not be as written
- **Requests & Responses**
    - Parse data into chunks (Streams and Buffers)
    - Avoid double responses
- **Node.js & Core Modules**
    - Node.js ships with multiple core modules (http, fs, path, os, etc.)
    - Core modules can be imported into any file
    - Import via ``require('module_name')``
- **The Node Module System**
    - Import via ``require('./path-to-file')`` for custom files or ``require('module_name')`` for core modules
    - Export via ``module.exports`` or ``exports`` (for multiple exports)

### Resources
- Official Node.js Docs: https://nodejs.org/en/guides/
- Full Node.js Reference (for all core modules): https://nodejs.org/dist/latest/docs/api/
- More about the Node.js Event Loop: https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/
- Blocking and Non-Blocking Code: https://nodejs.org/en/docs/guides/dont-block-the-event-loop/